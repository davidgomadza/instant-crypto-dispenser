<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Coins Dispensing Vending Machine (ICDVM) - Multi-Payment</title>
    
    <script async src="https://js.stripe.com/v3/buy-button.js"></script>

    <style>
        /* CSS remains largely the same, focusing on presentation and clarity */
        body { 
            font-family: 'Arial', sans-serif; 
            text-align: center; 
            background-color: #1a1a2e; 
            color: #e5e5f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container { 
            width: 90%;
            max-width: 750px; /* Wider to accommodate more options */
            padding: 30px; 
            border-radius: 20px; 
            background-color: #2c3e50; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.6), inset 0 0 10px rgba(255, 255, 255, 0.1); 
            border: 4px solid #f39c12;
        }
        h2 { 
            color: #f39c12; 
            margin-bottom: 25px;
            text-transform: uppercase;
        }
        h3 {
            color: #3498db;
            margin-top: 30px;
            padding-bottom: 5px;
            border-bottom: 2px solid #34495e;
        }
        .payment-options {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }
        .option-box {
            background-color: #34495e;
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            text-align: left;
        }
        .option-box h4 {
            color: #2ecc71;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .detail-label {
            font-weight: bold;
            color: #bdc3c7;
        }
        #status-message { 
            margin-top: 30px; 
            padding: 15px;
            font-size: 1.6em; 
            font-weight: bold; 
            background-color: #34495e;
            border-radius: 8px;
            min-height: 50px;
            color: #2ecc71;
        }
        .alert-note {
            background-color: #e67e22;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 0.9em;
            text-align: center;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ü™ô Instant Crypto Dispenser ü™ô</h2>
        
        <p style="font-size: 1.1em;">Purchase the full token bundle (6 tokens + 1 **BTCYT** fee coin).</p>

        <h3>‚úÖ Option 1: Instant Payment (Stripe)</h3>
        
        <p>Use your credit/debit card for immediate dispensing:</p>
        
        <stripe-buy-button
          buy-button-id="buy_btn_1SRJRlGZvDuiqgOEqk434sln"
          publishable-key="pk_live_51SRIXVGZvDuiqgOEm52B8spXYx5nBccSCYqvNfC5kwa2pNMpAaFys188ABFSulny24lOkO8KbGSo38ZN00L1bSX800ZKPfVB7Q"
        >
        </stripe-buy-button>
        <a href="https://buy.stripe.com/test_7sYdR9dpBdRsaDi4OwgnK00" target="_blank" style="display: block; margin-top: 10px;">Direct Stripe Payment Link</a>

        
        <h3>‚è≥ Option 2: Manual Payment (Requires Verification)</h3>
        
        <div class="alert-note">
            ‚ö†Ô∏è **IMPORTANT:** Manual payments are *not* instant. Tokens will only be dispensed after funds are received and **manually verified** by an administrator.
        </div>

        <div class="payment-options">
            <div class="option-box">
                <h4>üèõÔ∏è Bank Transfer (UK & International)</h4>
                
                <div class="detail-row"><span class="detail-label">Recipient:</span> <span>David Gomadza</span></div>
                
                <p style="margin: 10px 0; font-weight: bold;">üá¨üáß UK Transfer (Sort/Account):</p>
                <div class="detail-row"><span class="detail-label">Sort Code:</span> <span>**201181**</span></div>
                <div class="detail-row"><span class="detail-label">Account No:</span> <span>**83546098**</span></div>
                
                <p style="margin: 10px 0; font-weight: bold;">üåç International Transfer (SWIFT/IBAN):</p>
                <div class="detail-row"><span class="detail-label">SWIFT/BIC:</span> <span>**BUKBGB22**</span></div>
                <div class="detail-row"><span class="detail-label">IBAN:</span> <span>**GB93 BUKB 2011 8183 546098**</span></div>
            </div>

            <div class="option-box">
                <h4>üÖøÔ∏è PayPal or Crypto Transfer</h4>
                
                <p style="margin-top: 5px;">PayPal Email:</p>
                <div class="detail-row"><span class="detail-label">Email:</span> <span>**davidgomadza@hotmail.com**</span></div>
                
                <p style="margin-top: 15px;">Bitcoinayt (BTCYT) Address:</p>
                <div class="detail-row"><span class="detail-label">Crypto:</span> <span>**btcyt@bitcoinayt.world**</span></div>
                
                <p class="mt-4 text-xs text-gray-400">
                    *Note: The crypto address format suggests a human-readable payment system (e.g., wallet ID or payment handle).
                </p>
            </div>
        </div>

        <div id="status-message">Please select a payment method to begin...</div>
    </div>

    <script>
        // --- Configuration ---
        const checkInterval = 5000; // Check every 5 seconds
        const mockTransactionId = "TX-VEND-12345";
        
        // --- DOM References ---
        const statusMessage = document.getElementById('status-message');

        /**
         * Simulates claiming the 1 BTCYT fee coin from the Faucet.
         */
        function claimFaucetBTCYT(walletAddress) {
            statusMessage.innerHTML = "<span style='color:#f39c12'>‚öôÔ∏è **Funding Wallet...** Claiming 1 BTCYT fee coin from Faucet...</span>";
            
            return new Promise(resolve => {
                setTimeout(() => {
                    console.log(`FAUCET SIMULATION: Issued 1 BTCYT to new wallet ${walletAddress}`);
                    resolve({ success: true, amount: 1, symbol: 'BTCYT' });
                }, 3000); 
            });
        }

        /**
         * Executes the token dispensing process after payment confirmation.
         */
        async function triggerDispense(walletDetails) {
            // 1. Issue the BTCYT Fee Coin
            try {
                const faucetResult = await claimFaucetBTCYT(walletDetails.address);
                if (!faucetResult.success) {
                    throw new Error("Faucet claim failed.");
                }
            } catch (error) {
                statusMessage.innerHTML = "<span style='color:#e74c3c'>‚ùå **FATAL ERROR:** Fee coin claim failed. Contact support.</span>";
                return;
            }

            // 2. Tell the Java server to finalize the bulk token transfer
            statusMessage.innerHTML = "<span style='color:#3498db'>üöÄ **Transferring Bulk Tokens...** This may take a moment.</span>";
            
            fetch('/api/vending/dispense', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    transactionId: mockTransactionId,
                    walletDetails: walletDetails 
                })
            })
            .then(response => response.json())
            .then(data => {
                
                const mockSuccess = true;
                
                if (mockSuccess) {
                    statusMessage.innerHTML = `üéâ **Dispense Complete!** Your wallet is funded. **Grab your printed receipt!**`;
                    
                    console.log('===================================================');
                    console.log('               CRYPTOCURRENCY RECEIPT              ');
                    console.log('---------------------------------------------------');
                    console.log('DETAILS: (Printed on physical receipt)');
                    console.log(`WALLET CREATED: ${walletDetails.walletUrl}`);
                    console.log(`ADDRESS: ${walletDetails.address}`);
                    console.log('INITIAL CREDIT: 1 BTCYT (Fee Currency)');
                    console.log('TOKENS TRANSFERRED: AGT, S96t\', BTCYT, BTC, GTPS, AGOLD (Bulk)');
                    console.log('===================================================');
                    
                } else {
                    statusMessage.innerHTML = "<span style='color:#e74c3c'>‚ö†Ô∏è **Dispensing Error. Please contact support.**</span>";
                }
            });
        }

        /**
         * Polling function to check status from the Java Back-End.
         * This handles the confirmation for BOTH Stripe (instant) and Manual (admin-confirmed) payments.
         */
        function checkPaymentStatus() {
            // The Java Back-End must track both Stripe webhooks and Manual Confirmation flags.
            fetch('/api/vending/check_transaction_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ machineId: "ICDVM-001", transactionId: mockTransactionId })
            })
            .then(response => response.json())
            .then(data => {
                
                // --- MOCK DATA FOR DEMO PURPOSES ONLY ---
                const currentTime = new Date().getTime();
                let startTime = sessionStorage.getItem('startTime');
                
                if (!startTime) {
                    sessionStorage.setItem('startTime', currentTime);
                    startTime = currentTime;
                }
                const elapsed = currentTime - parseInt(startTime);
                
                let simulatedStatus = 'PENDING';
                let dispensed = sessionStorage.getItem('dispensed') === 'true';

                // Simulate payment success (either via Stripe or Manual Admin override)
                if (elapsed > 15000 && !dispensed) { 
                    simulatedStatus = 'PAID';
                    walletData = {
                        address: '0x1234567890ABCDEF', 
                        walletUrl: 'https://agtwallet-bestest.vercel.app/',
                        accessKey: 'PRINT-ME-SECRET-KEY'
                    };
                    sessionStorage.setItem('dispensed', 'true'); 
                }
                // --- END MOCK DATA ---
                
                if (simulatedStatus === 'PAID' && !dispensed) {
                    clearInterval(pollingInterval); 
                    triggerDispense(walletData);
                } else if (simulatedStatus === 'PENDING') {
                    // Update status for manual payments to guide the user
                    statusMessage.innerHTML = "Awaiting Payment or Admin Confirmation...";
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                statusMessage.innerHTML = "‚ùå **Error contacting server.** Please ensure the Java back-end is running.";
            });
        }

        // Start polling the server
        const pollingInterval = setInterval(checkPaymentStatus, checkInterval);
    </script>
</body>
</html>
